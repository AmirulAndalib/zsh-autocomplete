#!/bin/zsh

_autocomplete__max_lines() {
  emulate -L zsh -o extendedglob

  local max_lines; zstyle -s ":autocomplete:$curcontext" max-lines max_lines ||
    max_lines='40%'
  local -i screen_space=$(( LINES - BUFFERLINES - ${#${(f@)PS1}} + 2 ))
  [[ $max_lines == *% ]] &&
    (( max_lines = screen_space * ${max_lines%%\%} / 100 ))
  (( max_lines = min(max_lines, screen_space) ))

  return max_lines
}

functions -M _autocomplete__max_lines
